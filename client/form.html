<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - KRMU Green</title>
    <link rel="stylesheet" href="styles.css">
    <script src="js/session-guard.js"></script>

    <!-- Firebase Config handled by firebase-init.js at bottom -->
</head>

<body>
    <div class="video-bg-container">
        <video autoplay loop muted playsinline class="back-video" preload="metadata"
            poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1' /%3E">
            <source src="green-forest-moewalls-com.mp4" type="video/mp4">
        </video>
    </div>
    <div class="video-overlay"></div>

    <div id="toast" class="popup-toast">Correct!</div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Submitting your answers...</p>
        </div>
    </div>

    <!-- Success Screen Overlay -->
    <div id="success-screen" class="success-overlay" style="display: none;">
        <div class="success-content glass-panel">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M8 12l2.5 2.5L16 9" />
                </svg>
            </div>
            <h2 class="success-title">Quiz Submitted Successfully!</h2>
            <p class="success-subtitle">Great job completing the sustainability quiz</p>

            <div class="success-score-card">
                <span class="score-label">Your Score</span>
                <span class="score-value" id="finalScore">0</span>
                <span class="score-max">/ <span id="maxScore">100</span></span>
            </div>

            <div class="success-actions">
                <a href="dashboard.html" class="glow-btn success-btn-primary">
                    <span>Go to Dashboard</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                </a>
                <button id="retakeQuizBtn" class="glow-btn success-btn-secondary">Take Another Quiz</button>
            </div>
        </div>
    </div>

    <!-- Error Toast Container -->
    <div id="error-toast" class="error-toast" style="display: none;">
        <div class="error-toast-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 8v4M12 16h.01" />
            </svg>
            <span id="error-message">An error occurred</span>
        </div>
    </div>

    <nav class="navbar">
        <div class="brand">Sustainable <span class="glow-brand">QUIZ</span></div>
        <div style="display:flex; align-items:center; gap: 20px;">
            <div class="score-badge">Score: <span id="current-score">0</span></div>
            <span id="userRoll" style="color: var(--primary); font-size: 0.8rem;"></span>
            <button id="logoutBtn" class="glow-btn" style="font-size: 0.7rem;">Logout</button>
        </div>
    </nav>

    <div class="main-container">

        <!-- QUIZ CARD UI -->
        <div class="quiz-container">
            <div class="quiz-card">

                <!-- HEADER -->
                <div class="quiz-header">
                    <span class="quiz-category">KRMU Challenge</span>
                    <div class="quiz-progress">
                        <span id="q-current" style="color: var(--primary); font-weight: bold;">1</span>
                        <span style="opacity: 0.5;">/ 20</span>
                    </div>
                </div>

                <!-- MAIN SCROLL AREA -->
                <div class="quiz-scroll-area">
                    <!-- Department Selection Overlay (Initially Visible) -->
                    <div id="dept-selection"
                        style="position: absolute; inset: 0; background: rgba(15, 15, 15, 0.96); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px);">

                        <div style="text-align: center; max-width: 400px; padding: 2rem;">
                            <h2
                                style="color: white; margin-bottom: 0.5rem; font-family: var(--font-head); font-size: 2rem;">
                                Welcome</h2>
                            <p style="color: #888; margin-bottom: 2rem;">Select your department to begin the challenge.
                            </p>

                            <select id="departmentSelect" class="glow-btn"
                                style="width: 100%; text-align: left; margin-bottom: 1.5rem; background: rgba(255,255,255,0.05); color: white; border-color: rgba(255,255,255,0.2);">
                                <option value="" disabled selected>Choose Department...</option>
                                <option value="Computer Science">Computer Science (SOET)</option>
                                <option value="Law">Law (SOL)</option>
                                <option value="Management">Management (SOM)</option>
                                <option value="Engineering">Engineering (Mech/Civil/Electronics)</option>
                                <option value="Medical">Medical / Allied Health</option>
                                <option value="Fashion">Fashion & Design</option>
                                <option value="Journalism">Journalism & Mass Comm</option>
                                <option value="Basic Sciences">Basic Sciences</option>
                                <option value="Architecture">Architecture</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>

                            <button id="startQuizBtn" class="glow-btn" style="width: 100%;" disabled>Start Quiz</button>
                        </div>
                    </div>

                    <!-- Question -->
                    <h2 id="question-text" class="quiz-question">Loading Question...</h2>

                    <!-- Options Grid -->
                    <div id="options-container" class="quiz-options">
                        <!-- Options injected by JS -->
                    </div>

                    <!-- Insight Panel -->
                    <div id="insight-panel" class="insight-panel">
                        <div class="insight-content">
                            <div class="insight-title">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                                </svg>
                                Insight
                            </div>
                            <p id="explanation-text" class="insight-text">Explanation goes here...</p>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="quiz-footer">
                    <button id="viewExplBtn" class="btn-glass" style="display: none;">View Explanation</button>
                    <button id="nextBtn" class="glow-btn"
                        style="padding: 0.8rem 2rem; min-width: 120px; display: none;">Next</button>
                    <button id="skipBtn" class="btn-glass" style="border: none; color: #666;">Skip</button>
                </div>

            </div>
        </div>
    </div>



    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/env-config.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="script.js"></script>
    <script>
        // Check authentication via Firebase
        let currentUser = null;

        // Wait for Firebase to be ready
        function checkAuth() {
            if (!firebase || !firebase.auth) {
                setTimeout(checkAuth, 100);
                return;
            }

            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = {
                    email: user.email,
                    rollNumber: user.email.split('@')[0]
                };

                document.getElementById('userRoll').textContent = currentUser.rollNumber;

                // Trigger quiz initialization after auth check
                if (window.initQuiz) window.initQuiz(currentUser.rollNumber);
            });
        }

        checkAuth();

        document.getElementById('logoutBtn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>

</html>